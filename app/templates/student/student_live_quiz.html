<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Quiz - Room Code: {{ room.join_code }}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Full-Width Navbar -->
    <div class="container-fluid p-0">
        {% include 'partials/navbar.html' %}
    </div>

    <div class="container d-flex flex-column align-items-center justify-content-center mt-5">
        <!-- Quiz Header -->
        <div class="quiz-header text-center my-3">
            <h1 class="fw-bold">Live Quiz - Room Code: <span class="room-code">{{ room.join_code }}</span></h1>
            <p class="text-muted">Answer the following question:</p>
        </div>

        <!-- Question Box -->
        <div class="question-box p-4 shadow-lg rounded bg-light text-center my-4">
            <h2 id="question-text" class="fw-bold">Loading question...</h2>
        </div>

        <!-- Answer Options -->
        <div class="answer-container d-flex flex-wrap justify-content-center gap-3 mt-3">
            <button class="answer-box btn btn-outline-primary px-5 py-3">A. Option 1</button>
            <button class="answer-box btn btn-outline-primary px-5 py-3">B. Option 2</button>
            <button class="answer-box btn btn-outline-primary px-5 py-3">C. Option 3</button>
            <button class="answer-box btn btn-outline-primary px-5 py-3">D. Option 4</button>
        </div>

        <!-- Next Question Button -->
        <div class="next-container mt-4">
            <button id="next-question" class="btn btn-primary px-5 py-3 fw-bold">Next Question</button>
        </div>
    </div>

    <!-- Full-Width Footer -->
    <div class="container-fluid p-0">
        {% include 'partials/footer.html' %}
    </div>

    <!-- JavaScript for Interaction
    <script>
        $(document).ready(function() {
            $(".answer-box").click(function() {
                $(".answer-box").removeClass("selected btn-primary").addClass("btn-outline-primary");
                $(this).removeClass("btn-outline-primary").addClass("selected btn-primary");
            });

            $("#next-question").click(function() {
                alert("Next Question Coming Soon...");
            });
        });
    </script> -->

<script>
    $(document).ready(function() {
        let currentQuestionNumber = 0; 
        const joinCode = "{{ room.join_code }}";
        const ws = new WebSocket(`ws://${window.location.host}/ws/student/${joinCode}/`);

        // Handle WebSocket messages
        ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("Question type", data.type);

        
        if(data.type === "question_update") {
            currentQuestionNumber = data.question_number;
            $("#question-text").text(data.question);
            $(".quiz-header p").text(`Question ${data.question_number} of ${data.total_questions}`);
            
            const $answerContainer = $(".answer-container");
            $answerContainer.empty();

            if (data.question_type) {
            
                switch(data.question_type) {
                    case "multiple_choice":
                    case "true_false":
                        data.options.forEach((option, index) => {
                            $answerContainer.append(`
                                <button class="answer-box btn btn-outline-primary px-5 py-3">
                                    ${String.fromCharCode(65 + index)}. ${option}
                                </button>
                            `);
                        });
                        break;
                    case "integer":
                    case "decimal":
                        $answerContainer.html(`
                            <div class="form-group w-100">
                                <input type="number" class="form-control" placeholder="Enter your answer">
                            </div>
                        `);
                        break;
                    case "text":
                        $answerContainer.html(`
                            <div class="form-group w-100">
                                <textarea class="form-control" rows="3" placeholder="Type your answer here..."></textarea>
                            </div>
                        `);
                        break;
                    case "numerical_range":
                        $answerContainer.html(`
                            <div class="form-group w-100">
                                <input type="number" class="form-control" placeholder="Enter a number within the range">
                            </div>
                        `);
                        break;
                    case "sorting":
                        const $sortableList = $('<ul class="list-group sortable">');
                        data.items.forEach(item => {
                            $sortableList.append(`<li class="list-group-item">${item}</li>`);
                        });
                        $answerContainer.html($sortableList);
                        $(".sortable").sortable();
                        break;
                    
                    default:
                        console.error("Unknown question type:", data.question_type);
                }}
            else {
                console.error("Question type is undefined:", data);
        }
        }
        else if (data.type === "answer_received") {
            console.log("âœ… Answer received by server:", data);
        
            // Optionally, provide UI feedback (e.g., highlight answer)
            $(".answer-box").removeClass("btn-success");  // Remove previous highlight
            $(".answer-box").filter(function() {
                return $(this).text().includes(data.answer);
            }).addClass("btn-success");  // Highlight submitted answer
        }
};
        
    

        // Handle answer submission
    $(document).on('click', '.answer-box', function () {
        // For multiple-choice or true/false questions
        const answer = $(this).text().split('. ')[1]; // Extract the selected option
        ws.send(JSON.stringify({
            action: "submit_answer",
            answer: answer,
            question_number: currentQuestionNumber
        }));
        $(".answer-box").removeClass("active btn-primary");
        $(this).addClass("active btn-primary");
    });

    // Handle text-based answers (e.g., text, integer, decimal)
    $(document).on('blur', 'textarea, input[type="number"]', function () {
        // When the user leaves the input field, send their answer
        const answer = $(this).val(); // Get the value from the input field
        ws.send(JSON.stringify({
            action: "submit_answer",
            answer: answer,
            question_number: currentQuestionNumber
        }));
    });

    // Handle sorting-type answers
    $(document).on('sortupdate', '.sortable', function () {
        // When the user finishes sorting, send the new order
        const sortedItems = [];
        $('.sortable li').each(function () {
            sortedItems.push($(this).text()); // Collect the sorted items
        });
        ws.send(JSON.stringify({
            action: "submit_answer",
            answer: sortedItems,
            question_number: currentQuestionNumber
        }));
    });
        // // Handle answer submission
        // $(document).on('click', '.answer-box', function() {
        //     const answer = $(this).text().split('. ')[1];
        //     ws.send(JSON.stringify({
        //         action: "submit_answer",
        //         answer: answer,
        //         question_number: currentQuestionNumber
        //     }));
        //     $(".answer-box").removeClass("active btn-primary");
        //     $(this).addClass("active btn-primary");
        // });

        // Remove next question button - students shouldn't control progression
        $("#next-question").remove();
    });
</script>
