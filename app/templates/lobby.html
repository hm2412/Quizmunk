<!DOCTYPE html>
{% extends "base.html" %}
{% load static %}
{% block title %}Quiz Lobby{% endblock %}
{% block content %}
    <main>
        <section>
            <h2>Lobby for {{ room.name }}</h2>
            {% if room.classroom %}
                     {% if in_classroom %}
                         <p>Room Code: <strong>{{ join_code }}</strong></p>
                         <img src="{% static 'images/qr_code.png' %}" alt="Room QR Code"  width="200px" height="200px">

                         <h3>Participants:</h3>
                         <ul id="participants-list">
                             {% for participant in participants %}
                             <li>{{ participant }}</li>
                             {% endfor %}
                         </ul>
                         {% if room.quiz %}
                         <form method="POST" action="{% url 'tutor_live_quiz' quiz_id=room.quiz.id join_code=join_code %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Start Quiz</button>
                        </form>
                        {% else %}
                        <p>No quiz associated with this room.</p>
                        {% endif %}
                    {% else %}
                        <h2>This is a locked room</h2>
                        <h3>Only students in this classroom can join!</h3>
                    {% endif %}
                {% else %}
                    <p>Room Code: <strong>{{ join_code }}</strong></p>
                    <img src="{% static 'images/qr_code.png' %}" alt="Room QR Code"  width="200px" height="200px">

                    <h3>Participants:</h3>
                    <ul id="participants-list">
                        {% for participant in participants %}
                        <li>{{ participant }}</li>
                        {% endfor %}
                    </ul>
                    {% if room.quiz %}
                    <form method="POST" action="{% url 'tutor_live_quiz' quiz_id=room.quiz.id join_code=join_code %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Start Quiz</button>
                    </form>
                    {% else %}
                    <p>No quiz associated with this room.</p>
                    {% endif %}
                {% endif %}
    <script>
        const ws = new WebSocket(`ws://${window.location.host}/ws/lobby/{{ room.join_code }}/`);

        var userRole = "{{ request.user.role|default:'guest' }}";
        console.log("User role:", userRole);

        let quizStarted = false; 
        </section>
    </main>

<script>
    var userRole = "{{ request.user.role|default:'guest' }}";
    console.log("User role:", userRole);

    const ws = new WebSocket(`ws://${window.location.host}/ws/lobby/{{ join_code }}/`);

            
            if (data.action && data.action == "quiz_started"){
                if (!quizStarted) {
                    quizStarted = true; 
                    if(userRole == "tutor"){
                        window.location.href = data.tutor_quiz_url;
                    }else{
                        window.location.href = data.student_quiz_url;
                    }
                }
            }else if (data.participants) {
                const participantsList = document.getElementById("participants-list");
                participantsList.innerHTML = "";
                data.participants.forEach(participant => {
                    const li = document.createElement("li");
                    li.textContent = participant;
                    participantsList.appendChild(li);
                });
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.action && data.action == "quiz_started"){
            if(userRole == "tutor"){
                window.location.href = data.tutor_quiz_url;
            }else{
                window.location.href = data.student_quiz_url;
            }
        }else if (data.participants) {
            const participantsList = document.getElementById("participants-list");
            participantsList.innerHTML = "";
            data.participants.forEach(participant => {
                const li = document.createElement("li");
                li.textContent = participant;
                participantsList.appendChild(li);
            });
        }
    };

    ws.onopen = function() {
        console.log("WebSocket connected!");
    };

    ws.onerror = function(error) {
        console.error("WebSocket Error:", error);
    };
</script>
{% endblock %}
