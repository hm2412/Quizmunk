<!DOCTYPE html>
{% extends "base.html" %}
{% load static %}
{% block title %}Quiz Lobby{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/lobby.css' %}">
{% endblock %}
{% block content %}
    <main>
        <section>
            <h2 class="room-name">{{ room.name }}</h2>
            {% if room.classroom %}
                     {% if in_classroom %}
                         <p class="room-code">Room Code: <strong>{{ join_code }}</strong></p>
                         <img class="qr-code" src="{% static 'images/qr_code.png' %}" alt="Room QR Code">

                         <div id="participants-list" class="participants-grid">
                            {% for participant in participants %}
                            <div class="participant-box">{{ participant }}</div>
                            {% endfor %}
                        </div> 
                         {% if room.quiz %}
                         {% if user.is_authenticated and user.role == "tutor" %}
                            <form method="POST" action="{% url 'tutor_live_quiz' quiz_id=room.quiz.id join_code=join_code %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">Start Quiz</button>
                            </form>
                        {% endif %}
                        </form>
                        {% else %}
                        <p>No quiz associated with this room.</p>
                        {% endif %}
                    {% else %}
                        <h2>This is a locked room</h2>
                        <h3>Only students in this classroom can join!</h3>
                    {% endif %}
                {% else %}
                    <p class="room-code">Room Code: <strong>{{ join_code }}</strong></p>
                    <img class="qr-code" src="{% static 'images/qr_code.png' %}" alt="Room QR Code">

                    <div id="participants-list" class="participants-grid">
                        {% for participant in participants %}
                        <div class="participant-box">{{ participant }}</div>
                        {% endfor %}
                    </div>                    
                    {% if room.quiz %}
                    {% if user.is_authenticated and user.role == "tutor" %}
                            <form method="POST" action="{% url 'tutor_live_quiz' quiz_id=room.quiz.id join_code=join_code %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">Start Quiz</button>
                            </form>
                        {% endif %}
                    {% else %}
                    <p>No quiz associated with this room.</p>
                    {% endif %}
                {% endif %}
        </section>
    </main>

<script>
    const ws = new WebSocket(`ws://${window.location.host}/ws/lobby/{{ join_code }}/`);
    var userRole = "{{ request.user.role|default:'guest' }}";
    console.log("User role:", userRole);
    let quizStarted = false; 

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.action && data.action == "quiz_started"){
                if (!quizStarted) {
                    quizStarted = true; 
                    if(userRole == "tutor"){
                        window.location.href = data.tutor_quiz_url;
                    }else{
                        window.location.href = data.student_quiz_url;
                    }
                }
        }else if (data.participants) {
            const participantsList = document.getElementById("participants-list");
            participantsList.innerHTML = "";
            data.participants.forEach(participant => {
                const div = document.createElement("div");
                div.className = "participant-box";
                div.textContent = participant;
                
                // Generate a random color
                const randomColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                div.style.backgroundColor = randomColor;
                
                participantsList.appendChild(div);
            });
        }
    };

    ws.onopen = function() {
        console.log("WebSocket connected!");
    };

    ws.onerror = function(error) {
        console.error("WebSocket Error:", error);
    };
</script>
{% endblock %}
