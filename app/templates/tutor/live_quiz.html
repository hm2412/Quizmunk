<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Quiz: Quiz Name</title>
  <!-- Include Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Link to your custom stylesheet -->
  <link rel="stylesheet" href="{% static 'css/live_quiz.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
  <div class="page-container">
    <!-- Main Content -->
    <div class="main-content">
      <div class="content-area">
        <!-- Current Question -->
        <div class="question-container">
          <h2 class="h4">Question 1</h2>  
          <p class="question">Press "Start Quiz" to begin!</p>
        </div>
         <!-- Correct Answer -->
         <div class="row">
          <div class="col-sm-6">
            <h2 class="h4">Correct Answer</h2>
            <p class="answer">Answer will be displayed here.</p>
          </div>
        </div>
        <!-- Leaderboard -->
        <div class="leaderboard-container">
          <h2 class="h5">Leaderboard</h2>
          <ul class="list-group mt-2">
            {% for leader in leaders %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {% if leader.user %}
                {{ leader.user.first_name }}
              {% elif leader.guest_access %}
                Guest {{ leader.guest_access.session_id|slice:":8" }}
              {% else %}
                Guest
              {% endif %}          
              <span class="badge bg-primary rounded-pill">{{leader.score}} pts</span>
            </li>
            {% empty %}
            <li class="list-group-item">No participants yet.</li>
            {% endfor %}
          </ul>
        </div>
        <!--Progress bar for questions-->
        <div class="progress" role="-question-progressbar" aria-label="example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar" style="width: 25%">Question Progress</div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Time Left -->
        <div class="circle">
          <div>
            <p class="mb-0 h5">[time]</p>
            <p class="small">seconds</p>
          </div>
        </div>

        <!-- Ratio for students answered vs students joined  -->
        <div class="circle">
          <div>
            <script type="text/javascript">
              const ws = new WebSocket(`ws://${window.location.host}/ws/live-quiz/{{join_code}}/`);

              ws.onopen = () => {
                console.log("Websocket connected!");
              }

              ws.onmessage = function(event) {
                let data = JSON.parse(event.data);
                console.log('Data:', data);
              }
            </script>
            <p class="mb-0 h5">[no of students answered / {{ participant_number }}]</p>
          </div>
        </div>

        <div id="quiz-controls">
            <button id="start-quiz-btn" class="btn btn-success">
                ‚ñ∂ Start Quiz
            </button>

                <!-- Next Question Button -->
            <button id="next-question-btn" class="btn btn-primary">
                ‚è≠ Next Question
            </button>

             <!-- End Question Button -->
            <button id="end-question-btn" class="btn btn-primary">
              ‚è≠ End Question
          </button>

                <!-- End Quiz Button -->
            <button id="end-quiz-btn" class="btn btn-danger">
                ‚èπ End Quiz
            </button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      {% include 'partials/footer.html' %}
    </footer>
  </div>

  <!-- Include Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- JS for action buttons -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const startQuizBtn = document.getElementById("start-quiz-btn");
      const nextQuestionBtn = document.getElementById("next-question-btn");
      const endQuestionBtn = document.getElementById("end-question-btn");
      const endQuizBtn = document.getElementById("end-quiz-btn");

      const questionText = document.querySelector(".question"); // Target question text
      const questionNumber = document.querySelector(".question-container h2"); // Target question number
      const answerText = document.querySelector(".answer"); // Target answer field
      const quizControls = document.getElementById("quiz-controls"); // Controls section



        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('Received question data:', data);

            // Update the question text and options dynamically
            if (data.type === "quiz_update") {
                questionNumber.textContent = `Question ${data.message.question_number}`;
                questionText.textContent = data.message.question;
                answerText.textContent = data.message.answer;  // Modify if you need multiple options
            }
        };

      function sendRequest(url, callback){
        fetch(url,{
          method:"POST",
          headers:{
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify({})
        })
        .then(response=>response.json())
        .then(data=>{
          callback(data);
        })
        .catch(error=>console.error("Error:",error));
      }

      startQuizBtn.addEventListener("click", function() {
        sendRequest("/start-quiz/",function(data){
          startQuizBtn.textContent = "Quiz Started ‚úÖ";
          startQuizBtn.disabled = true; // Disable after starting
          nextQuestionBtn.style.display = "inline-block"; // Show "Next Question"
        });
      });

      nextQuestionBtn.addEventListener("click", function () {
        sendRequest("/next-question/", function(data) {
            if (data.question && data.answer) {
                questionNumber.textContent = `Question ${data.question_number}`;
                questionText.textContent = data.question;
                answerText.textContent = data.answer;
            }
        });
    });
    endQuizBtn.addEventListener("click", function () {
        sendRequest("/end-quiz/", function(data) {
            quizControls.innerHTML = `<h2 class="text-danger">Quiz Ended üöÄ</h2>`;
            questionText.textContent = "";
            answerText.textContent = "";
            nextQuestionBtn.style.display = "none"; // Hide Next Question button
        });
    });
    
      function getCSRFToken() {
          return document.cookie.split('; ')
              .find(row => row.startsWith('csrftoken='))
              ?.split('=')[1];
      }
  });
</script>
</body>
</html>

